# Feature Specification: 網路通訊協議圖形化展示系統

**Feature Branch**: `001-protocol-visualization`
**Created**: 2025-11-16
**Status**: Draft
**Input**: User description: "完成網路通訊協議的圖形化展示功能，涵蓋從後端產生協定時間軸到前端動畫渲染與互動控制"

## Clarifications

### Session 2025-11-16

- Q: 上傳並解析的 PCAP 檔案及其生成的 JSON 結果應該保留多久？ → A: 會話期間
- Q: 當多個用戶（不同會話）同時上傳 PCAP 檔案時，系統應該如何處理？ → A: 並發處理（隔離）
- Q: API 端點是否需要驗證機制（authentication）？ → A: 會話驗證
- Q: 後端產生的錯誤日誌（解析錯誤、系統異常等）應該如何保留和管理？ → A: 即時輸出不保留

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看網路協定動畫視覺化 (Priority: P1)

網路分析師需要快速理解複雜的網路通訊行為。系統應自動將 PCAP 封包資料轉換為視覺化的協定動畫，讓分析師能直觀地看到 TCP 握手、DNS 查詢、HTTP 請求等協定互動流程。

**Why this priority**: 這是系統的核心價值主張。沒有視覺化動畫，系統就失去了存在意義。這是最小可行產品（MVP）的必要功能。

**Independent Test**: 可以透過載入預先準備的 PCAP 檔案，驗證系統是否正確顯示 TCP 三向握手、DNS 查詢-回應、HTTP 請求-回應等常見協定的動畫。測試成功標準是協定動畫正確呈現各階段（如 SYN、SYN-ACK、ACK）且視覺上可識別。

**Acceptance Scenarios**:

1. **Given** 系統已載入包含 TCP 三向握手的 PCAP 檔案，**When** 分析師查看主畫面，**Then** 系統顯示從來源到目的地的連線，並以動畫方式依序呈現 SYN（藍色）、SYN-ACK（綠色）、ACK（青色）三個階段
2. **Given** 系統已載入包含 DNS 查詢的 PCAP 檔案，**When** 分析師查看主畫面，**Then** 系統顯示 DNS 查詢（紫色）從客戶端到伺服器，以及回應（紫色）從伺服器返回客戶端的動畫
3. **Given** 系統已載入包含 HTTP 請求的 PCAP 檔案，**When** 分析師查看主畫面，**Then** 系統顯示 HTTP 請求（橙色）階段：請求發送、處理中、回應接收，每個階段都有清楚的視覺標示
4. **Given** 系統已載入包含連線逾時的 PCAP 檔案，**When** 分析師查看主畫面，**Then** 系統以漸變的顏色（綠→黃→橙→紅）和減速的動畫呈現逾時過程
5. **Given** 系統同時顯示多個協定的動畫，**When** 分析師查看主畫面，**Then** 每個協定都使用不同的顏色和視覺樣式以便區分（TCP=藍綠、DNS=紫、HTTP=橙、UDP=虛線、Timeout=紅）

---

### User Story 2 - 上傳並分析 PCAP 檔案 (Priority: P2)

網路分析師需要分析自己捕獲的網路封包。系統應支援上傳 PCAP/PCAPNG 檔案，自動解析封包內容，生成協定時間軸，並將結果以視覺化方式呈現。

**Why this priority**: 這是系統的主要輸入來源。雖然可以先用預載資料進行展示（P1），但要讓系統真正有用，必須支援用戶上傳自己的資料。

**Independent Test**: 可以透過上傳測試用的 PCAP 檔案（包含已知的協定序列），驗證系統是否正確解析並生成對應的時間軸和動畫。測試成功標準是上傳後能看到正確的協定視覺化，且與預期的封包內容一致。

**Acceptance Scenarios**:

1. **Given** 分析師已登入系統並在主畫面，**When** 點擊「上傳封包」按鈕並選擇一個有效的 .pcap 檔案，**Then** 系統顯示上傳進度，解析完成後自動刷新畫面並顯示新的協定動畫
2. **Given** 分析師已登入系統並在主畫面，**When** 點擊「上傳封包」按鈕並選擇一個有效的 .pcapng 檔案，**Then** 系統顯示上傳進度，解析完成後自動刷新畫面並顯示新的協定動畫
3. **Given** 未登入的訪客嘗試存取上傳功能，**When** 發送 API 請求至 `/api/analyze`，**Then** 系統返回 HTTP 401 Unauthorized，並重導向至登入頁面
4. **Given** 分析師嘗試上傳檔案，**When** 選擇了非 PCAP 格式的檔案（如 .txt），**Then** 系統顯示錯誤訊息「不支援的檔案格式，請上傳 .pcap 或 .pcapng 檔案」
5. **Given** 分析師上傳了超大的 PCAP 檔案（>100MB），**When** 解析過程需要較長時間，**Then** 系統顯示即時進度條和預估剩餘時間，不會讓畫面凍結
6. **Given** 分析師上傳的 PCAP 檔案包含損壞的封包資料，**When** 後端嘗試解析，**Then** 系統跳過損壞的封包，成功解析有效的部分，並在結果中顯示警告訊息「檔案包含 X 個無法解析的封包」

---

### User Story 3 - 控制動畫播放與互動 (Priority: P3)

網路分析師在查看複雜的協定互動時，需要能夠暫停、播放、調整速度，以及聚焦於特定連線進行詳細觀察。

**Why this priority**: 這提升了使用體驗，但不是核心功能。即使沒有播放控制，分析師仍然可以看到動畫（P1）和上傳資料（P2）。播放控制是錦上添花的功能。

**Independent Test**: 可以透過載入包含多個連線的 PCAP 檔案，測試暫停/播放按鈕、速度調整、焦點模式等互動功能是否正常運作。測試成功標準是所有控制按鈕都能即時響應且動畫狀態正確更新。

**Acceptance Scenarios**:

1. **Given** 系統正在播放協定動畫，**When** 分析師點擊「暫停」按鈕，**Then** 所有動畫停止在當前位置，圓點和標籤保持靜止狀態
2. **Given** 系統已暫停動畫，**When** 分析師點擊「播放」按鈕，**Then** 所有動畫從暫停位置繼續播放
3. **Given** 系統正在播放動畫，**When** 分析師點擊特定連線，**Then** 該連線被選中（高亮顯示），側邊欄對應項目也被高亮，其他連線保持正常顯示
4. **Given** 系統已選中特定連線，**When** 分析師點擊「特定顯示」按鈕，**Then** 系統進入焦點模式，只顯示被選中的連線，其他連線隱藏，且動畫自動暫停
5. **Given** 系統處於焦點模式，**When** 分析師點擊「退出焦點」按鈕，**Then** 系統返回正常視圖，顯示所有連線
6. **Given** 系統正在播放動畫，**When** 分析師滑鼠懸停在某個連線上，**Then** 該連線高亮顯示（加粗、放大圓點），其他連線變暗（透明度降至 15%），並顯示浮動提示框（協定類型、當前階段、進度百分比）
7. **Given** 分析師查看包含 30+ 個連線的複雜網路，**When** 滑鼠移開連線，**Then** 所有連線恢復正常顯示，提示框消失

---

### User Story 4 - 查看協定統計與拓撲圖 (Priority: P4)

網路分析師需要了解整體網路結構和協定分布情況。系統應提供網路拓撲圖（力導向圖），顯示所有 IP 節點及其連線關係，並支援拖曳節點調整布局。

**Why this priority**: 這是輔助功能，幫助分析師從宏觀角度理解網路結構。但對於專注於協定細節的分析任務，這不是必要的。可以在後期迭代中完善。

**Independent Test**: 可以透過載入包含多個 IP 來源/目的地的 PCAP 檔案，驗證拓撲圖是否正確顯示所有節點和連線，且節點位置合理分散。測試成功標準是節點不重疊、可拖曳、連線清晰可見。

**Acceptance Scenarios**:

1. **Given** 系統已載入 PCAP 檔案，**When** 分析師查看主畫面，**Then** 系統顯示力導向拓撲圖，中心節點（連線數最多的 IP）位於畫面中央，其餘節點環繞分布
2. **Given** 拓撲圖已顯示，**When** 分析師拖曳某個周邊節點，**Then** 該節點跟隨滑鼠移動，釋放後保持新位置，力導向模擬暫停
3. **Given** 拓撲圖有多個節點重疊或過於擁擠，**When** 系統完成初始布局計算（100 次迭代），**Then** 所有節點均勻分散，節點間距符合最小距離要求，無重疊現象
4. **Given** 拓撲圖顯示後布局達到穩定狀態，**When** 系統偵測到總動能低於穩定閾值，**Then** 力導向模擬自動停止，節點位置固定，並自動縮放視圖使所有節點可見（Fit-to-View）
5. **Given** 分析師已縮放或平移視圖，**When** 點擊「重置視圖」按鈕，**Then** 視圖恢復到初始狀態（scale=1, 位移=0）

---

### Edge Cases

- **大型 PCAP 檔案處理**：當 PCAP 檔案包含超過 10,000 個封包時，系統如何避免前端渲染效能問題？
  - 假設：系統應實施分頁或虛擬化渲染，每次只渲染可見視窗內的連線，其餘連線延遲載入

- **損壞的封包資料**：當 PCAP 檔案包含格式錯誤或不完整的封包時，系統如何處理？
  - 策略：後端應跳過無法解析的封包，將錯誤訊息輸出到 stdout/stderr（不寫入檔案，依賴容器或系統日誌管理），繼續處理有效封包，並在前端顯示警告訊息「檔案包含 X 個無法解析的封包」

- **空 PCAP 檔案**：當用戶上傳一個不包含任何封包的 PCAP 檔案時，系統如何回應？
  - 假設：系統應顯示友善的訊息「此檔案不包含任何封包資料，請上傳有效的網路捕獲檔案」

- **不支援的協定**：當 PCAP 檔案包含系統尚未支援視覺化的協定（如 ICMP、ARP）時，系統如何處理？
  - 假設：系統應在統計資料中顯示這些協定的存在，但不為其生成動畫，並在側邊欄標註「此協定尚未支援視覺化」

- **網路拓撲 NaN 錯誤**：當力導向圖計算過程中出現座標為 NaN 的節點時，系統如何防止渲染錯誤？
  - 假設：系統應在每次座標更新時驗證數值有效性（isFinite），檢測到 NaN 時自動重置節點到畫布中心並清零速度

- **同一用戶連續上傳**：當同一用戶快速連續上傳多個 PCAP 檔案時，系統如何避免狀態混亂？
  - 策略：系統應取消前一個未完成的上傳/解析任務，只處理最新的檔案，並顯示訊息「已取消先前的上傳任務」

- **多用戶並發上傳**：當多個不同用戶（不同會話）同時上傳 PCAP 檔案時，系統如何確保資料隔離？
  - 策略：系統支援並發處理，每個會話的上傳檔案和解析結果完全隔離。使用會話 ID 作為命名空間，確保用戶 A 的上傳不會影響用戶 B 的結果。每個會話只能存取自己上傳的檔案和生成的時間軸資料

- **超長連線停滯**：當某個 TCP 連線長時間（>10 分鐘）沒有任何封包傳輸時，系統如何視覺化？
  - 假設：系統應將此類連線標記為「閒置」（灰色虛線），不播放動畫，避免干擾活躍連線的觀察

- **會話結束時的資料清理**：當用戶關閉瀏覽器或登出系統時，之前上傳的 PCAP 檔案及其解析結果應如何處理？
  - 策略：系統自動清理所有臨時檔案（上傳的 PCAP 和生成的 JSON），只保留預載的示範資料（位於 `public/data/` 的靜態檔案）。清理過程在後端透過會話過期機制觸發，不影響前端使用體驗

## Requirements *(mandatory)*

### Functional Requirements

#### 後端需求（PCAP 解析與時間軸生成）

- **FR-001**: 系統必須能夠解析 PCAP 和 PCAPNG 格式的網路捕獲檔案
- **FR-002**: 系統必須能夠識別並提取以下協定的封包：TCP、UDP、DNS、HTTP、HTTPS
- **FR-003**: 系統必須為每個識別的協定連線生成時間軸（Timeline），包含以下資訊：
  - 唯一識別碼（由協定、來源 IP、來源埠、目的 IP、目的埠、索引組成）
  - 協定類型（protocolType）：tcp-handshake、dns-query、http-request、https-request、udp-transfer、timeout
  - 開始與結束時間戳（epoch 毫秒）
  - 階段序列（stages）：每個階段包含鍵值、標籤、方向、持續時間、封包參考
  - 度量資料（metrics）：如 RTT、封包計數等
- **FR-004**: 系統必須為 TCP 連線偵測三向握手（SYN、SYN-ACK、ACK），並生成對應的時間軸階段
- **FR-005**: 系統必須為 UDP 連線偵測 DNS 查詢（埠 53），並生成查詢-解析-回應的時間軸階段
- **FR-006**: 系統必須為 HTTP/HTTPS 連線（埠 80/443）偵測請求-處理-回應的時間軸階段
- **FR-007**: 系統必須偵測連線逾時（封包間隔 >3 秒），並生成逐漸減速的逾時時間軸
- **FR-008**: 系統必須為所有時間軸階段設定最小持續時間，以確保動畫可見性：
  - TCP 握手每階段最少 800ms
  - UDP/DNS 傳輸最少 1200ms
  - HTTP/HTTPS 階段最少 600ms
- **FR-009**: 系統必須將解析結果輸出為 JSON 格式，包含：
  - 來源檔案清單（sourceFiles）
  - 生成時間（generatedAt）
  - 時間軸陣列（timelines）
- **FR-010**: 系統必須將生成的 JSON 檔案同時儲存至根目錄和 `public/data/` 目錄，以支援前端靜態回退。上傳的 PCAP 檔案及其生成的 JSON 結果只在用戶瀏覽器會話期間保留，會話結束後（關閉瀏覽器或登出）系統自動清理這些臨時檔案
- **FR-011**: 系統必須提供以下 RESTful API 端點：
  - `GET /api/health`：健康檢查（無需驗證）
  - `GET /api/analysis`：取得快取的分析結果（需要會話驗證）
  - `GET /api/timelines`：取得協定時間軸資料（需要會話驗證）
  - `POST /api/analyze`：接受上傳的 PCAP 檔案並觸發分析（需要會話驗證）
- **FR-011a**: 系統必須對所有 API 端點（除 `/api/health` 外）實施會話驗證。未登入的請求應返回 HTTP 401 Unauthorized，並重導向至登入頁面。驗證機制使用瀏覽器會話 cookie，無需額外的 API key 或 token
- **FR-012**: 系統必須驗證上傳檔案的格式（只接受 .pcap 和 .pcapng），拒絕其他格式並返回錯誤訊息
- **FR-013**: 系統必須處理包含非 ASCII 檔案路徑的 PCAP 檔案，使用臨時 ASCII 檔名進行處理
- **FR-013a**: 系統必須支援多用戶並發上傳與解析，使用會話 ID 作為命名空間隔離每個用戶的檔案和結果。每個會話只能存取自己上傳的 PCAP 檔案和生成的 JSON 資料，確保資料隔離與隱私保護
- **FR-013b**: 系統必須將所有錯誤訊息、警告訊息、系統異常輸出到 stdout（一般訊息）和 stderr（錯誤訊息），不寫入本地日誌檔案。日誌管理依賴容器編排平台（如 Docker、Kubernetes）或系統日誌服務（如 systemd journal）進行收集與保留

#### 前端需求（動畫渲染與互動控制）

- **FR-014**: 系統必須在主畫面顯示力導向網路拓撲圖，以視覺化方式呈現所有 IP 節點及其連線關係
- **FR-015**: 系統必須將連線數最多的 IP 節點作為中心節點，固定於畫布中央，其餘節點環繞分布
- **FR-016**: 系統必須為每條協定時間軸建立對應的動畫控制器（ProtocolAnimationController），管理動畫狀態與進度
- **FR-017**: 系統必須使用 `requestAnimationFrame` 驅動動畫循環，以 delta time 推進所有動畫控制器
- **FR-018**: 系統必須為每種協定類型顯示特定的視覺樣式：
  - TCP 握手：藍色→綠色→青色漸變，實線
  - DNS 查詢：紫色，實線
  - HTTP 請求：橙色，實線
  - HTTPS 請求：綠色，實線
  - UDP 傳輸：藍色，虛線
  - 逾時：綠色→黃色→橙色→紅色漸變，實線
- **FR-019**: 系統必須在每條連線上顯示動畫圓點，沿著連線路徑移動，表示封包傳輸方向
- **FR-020**: 系統必須在動畫圓點上方顯示兩行文字標籤：
  - 第一行：協定類型（大寫，白色，較大字體）
  - 第二行：當前階段名稱（青色，較小字體）
- **FR-021**: 系統必須提供「暫停」和「播放」按鈕，控制所有動畫的播放狀態
- **FR-022**: 系統必須在用戶選中特定連線後，顯示「特定顯示」按鈕，進入焦點模式（隱藏其他連線，自動暫停動畫）
- **FR-023**: 系統必須在焦點模式下提供「退出焦點」按鈕，返回正常視圖
- **FR-024**: 系統必須在用戶滑鼠懸停於連線時，顯示浮動提示框，包含：
  - 協定類型
  - 當前階段名稱
  - 進度百分比
- **FR-025**: 系統必須在用戶滑鼠懸停於連線時，高亮該連線（加粗、放大圓點），並將其他連線的透明度降至 15%
- **FR-026**: 系統必須在用戶點擊連線時，選中該連線（持續高亮），並在側邊欄對應項目上顯示青色邊框與光環效果
- **FR-027**: 系統必須在側邊欄顯示所有連線的清單，每個項目包含：
  - 協定類型圖示與名稱
  - 當前階段名稱
  - 進度百分比
  - 來源與目的 IP
- **FR-028**: 系統必須支援用戶點擊側邊欄項目來選中對應的連線（與點擊圖上連線效果相同）
- **FR-029**: 系統必須提供「上傳封包」按鈕，允許用戶選擇並上傳 .pcap 或 .pcapng 檔案
- **FR-030**: 系統必須在上傳過程中顯示進度指示器，完成後顯示成功訊息並自動刷新畫面
- **FR-031**: 系統必須在上傳失敗時顯示錯誤訊息，說明失敗原因
- **FR-032**: 系統必須在力導向拓撲圖中實施五種物理力：
  - 斥力（節點間相互排斥）
  - 引力（連線兩端相互吸引）
  - 重力（向中心聚集）
  - 碰撞力（防止節點重疊）
  - 邊界力（防止節點黏在邊緣和角落）
- **FR-033**: 系統必須在力導向模擬穩定後（總動能低於閾值），自動執行 Fit-to-View，將所有節點縮放至可視範圍
- **FR-034**: 系統必須提供「重置視圖」按鈕，將縮放和平移狀態重置為初始值
- **FR-035**: 系統必須在用戶拖曳節點時，暫停力導向模擬，釋放後恢復模擬
- **FR-036**: 系統必須驗證所有節點座標的有效性（isFinite），檢測到 NaN 時自動重置節點到畫布中心
- **FR-037**: 系統必須為每個連線生成唯一識別碼（包含索引後綴），避免 React key 重複警告
- **FR-038**: 系統必須優先嘗試從 API 端點（/api/timelines）載入資料，失敗時自動回退到靜態 JSON 檔案（/data/protocol_timeline_sample.json）

### Key Entities

- **封包（Packet）**：網路捕獲檔案中的單一資料單元，包含：
  - 時間戳（timestamp）
  - 來源 IP 與埠（source IP/port）
  - 目的 IP 與埠（destination IP/port）
  - 協定類型（protocol）
  - 封包長度（length）
  - 負載資料（payload）

- **協定時間軸（Protocol Timeline）**：從封包序列中提取的邏輯連線，包含：
  - 唯一識別碼（id）：由協定、來源、目的、索引組成
  - 協定類型（protocolType）：tcp-handshake、dns-query、http-request 等
  - 時間範圍（startEpochMs、endEpochMs）
  - 階段序列（stages）：每個階段描述一個協定步驟
  - 度量資料（metrics）：RTT、封包計數等統計資訊
  - 關聯封包（packetRefs）：指向原始封包的參考

- **動畫階段（Animation Stage）**：協定時間軸中的一個步驟，包含：
  - 鍵值（key）：階段的唯一識別符（如 'syn', 'syn-ack', 'ack'）
  - 標籤（label）：階段的顯示名稱（如 'SYN Sent', 'SYN-ACK 收到'）
  - 方向（direction）：forward（正向）、backward（反向）、both（雙向）、wait（等待）、none（無）
  - 持續時間（durationMs）：階段持續的毫秒數
  - 封包參考（packetRefs）：此階段對應的封包索引

- **動畫控制器（Animation Controller）**：管理單一時間軸的動畫狀態，包含：
  - 時間軸資料（timeline）
  - 當前進度（progress）：0.0 到 1.0
  - 當前階段（currentStage）
  - 播放速度（playbackSpeed）
  - 最終狀態（finalState）：completed、failed、timeout
  - 可渲染狀態（renderable state）：包含圓點位置、顏色、標籤等

- **網路節點（Network Node）**：拓撲圖中的 IP 位址節點，包含：
  - 節點 ID（id）：IP 位址
  - 標籤（label）：顯示名稱
  - 位置（x, y）：畫布上的座標
  - 速度（vx, vy）：力導向模擬中的速度向量
  - 是否為中心（isCenter）：標記連線數最多的節點
  - 協定清單（protocols）：此節點參與的協定類型

- **網路連線（Network Connection）**：拓撲圖中的連線線段，包含：
  - 連線 ID（id）：唯一識別碼
  - 來源節點（sourceId）
  - 目的節點（targetId）
  - 協定類型（protocolType）
  - 時間軸參考（timelineId）：對應的協定時間軸

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶上傳中型 PCAP 檔案（1,000-5,000 封包）後，系統在 5 秒內完成解析並顯示協定動畫
- **SC-002**: 協定動畫在主流瀏覽器（Chrome、Firefox、Edge）上以 60 FPS 流暢播放，無明顯卡頓或延遲
- **SC-003**: 系統支援至少 5 種協定類型的視覺化：TCP 握手、DNS 查詢、HTTP 請求、HTTPS 請求、UDP 傳輸、連線逾時
- **SC-004**: 用戶能在 3 次點擊內完成以下操作：上傳 PCAP 檔案、暫停/播放動畫、進入/退出焦點模式、重置視圖
- **SC-005**: 力導向拓撲圖在處理 30 個節點時，所有節點在 3 秒內達到穩定布局（無重疊、均勻分散）
- **SC-006**: 當用戶懸停於連線時，浮動提示框在 100ms 內出現，顯示正確的協定類型、階段名稱、進度百分比
- **SC-007**: 系統在 API 端點無法存取時，自動回退到靜態 JSON 檔案，用戶無感知切換（載入時間增加不超過 1 秒）
- **SC-008**: 系統處理大型 PCAP 檔案（10,000+ 封包）時，前端介面保持響應，不會凍結超過 2 秒
- **SC-009**: 90% 的用戶在首次使用時，無需查看說明文件即可成功完成「上傳 PCAP → 查看動畫 → 選中連線 → 進入焦點模式」的完整流程
- **SC-010**: 系統在處理包含 100+ 連線的複雜網路時，所有連線的動畫控制器能同步運行，CPU 使用率不超過 80%
- **SC-011**: 用戶拖曳節點調整拓撲圖布局時，節點跟隨滑鼠移動的延遲不超過 50ms，視覺上感覺即時響應
- **SC-012**: 系統在偵測到節點座標為 NaN 時，能在下一幀自動修復（重置到畫布中心），瀏覽器控制台無錯誤日誌
