{
  "url": "https://fastapi.tiangolo.com/advanced/behind-a-proxy/",
  "title": "Behind a Proxy¬∂",
  "content": "In many situations, you would use a proxy like Traefik or Nginx in front of your FastAPI app.\n\nThese proxies could handle HTTPS certificates and other things.\n\nA proxy in front of your application would normally set some headers on the fly before sending the requests to your server to let the server know that the request was forwarded by the proxy, letting it know the original (public) URL, including the domain, that it is using HTTPS, etc.\n\nThe server program (for example Uvicorn via FastAPI CLI) is capable of interpreting these headers, and then passing that information to your application.\n\nBut for security, as the server doesn't know it is behind a trusted proxy, it won't interpret those headers.\n\nThe proxy headers are:\n\nYou can start FastAPI CLI with the CLI Option --forwarded-allow-ips and pass the IP addresses that should be trusted to read those forwarded headers.\n\nIf you set it to --forwarded-allow-ips=\"*\" it would trust all the incoming IPs.\n\nIf your server is behind a trusted proxy and only the proxy talks to it, this would make it accept whatever is the IP of that proxy.\n\nFor example, let's say you define a path operation /items/:\n\nIf the client tries to go to /items, by default, it would be redirected to /items/.\n\nBut before setting the CLI Option --forwarded-allow-ips it could redirect to http://localhost:8000/items/.\n\nBut maybe your application is hosted at https://mysuperapp.com, and the redirection should be to https://mysuperapp.com/items/.\n\nBy setting --proxy-headers now FastAPI would be able to redirect to the right location. üòé\n\nIf you want to learn more about HTTPS, check the guide About HTTPS.\n\nHere's a visual representation of how the proxy adds forwarded headers between the client and the application server:\n\nThe proxy intercepts the original client request and adds the special forwarded headers (X-Forwarded-*) before passing the request to the application server.\n\nThese headers preserve information about the original request that would otherwise be lost:\n\nWhen FastAPI CLI is configured with --forwarded-allow-ips, it trusts these headers and uses them, for example to generate the correct URLs in redirects.\n\nYou could have a proxy that adds a path prefix to your application.\n\nIn these cases you can use root_path to configure your application.\n\nThe root_path is a mechanism provided by the ASGI specification (that FastAPI is built on, through Starlette).\n\nThe root_path is used to handle these specific cases.\n\nAnd it's also used internally when mounting sub-applications.\n\nHaving a proxy with a stripped path prefix, in this case, means that you could declare a path at /app in your code, but then, you add a layer on top (the proxy) that would put your FastAPI application under a path like /api/v1.\n\nIn this case, the original path /app would actually be served at /api/v1/app.\n\nEven though all your code is written assuming there's just /app.\n\nAnd the proxy would be \"stripping\" the path prefix on the fly before transmitting the request to the app server (probably Uvicorn via FastAPI CLI), keeping your application convinced that it is being served at /app, so that you don't have to update all your code to include the prefix /api/v1.\n\nUp to here, everything would work as normally.\n\nBut then, when you open the integrated docs UI (the frontend), it would expect to get the OpenAPI schema at /openapi.json, instead of /api/v1/openapi.json.\n\nSo, the frontend (that runs in the browser) would try to reach /openapi.json and wouldn't be able to get the OpenAPI schema.\n\nBecause we have a proxy with a path prefix of /api/v1 for our app, the frontend needs to fetch the OpenAPI schema at /api/v1/openapi.json.\n\nThe IP 0.0.0.0 is commonly used to mean that the program listens on all the IPs available in that machine/server.\n\nThe docs UI would also need the OpenAPI schema to declare that this API server is located at /api/v1 (behind the proxy). For example:\n\nIn this example, the \"Proxy\" could be something like Traefik. And the server would be something like FastAPI CLI with Uvicorn, running your FastAPI application.\n\nTo achieve this, you can use the command line option --root-path like:\n\nIf you use Hypercorn, it also has the option --root-path.\n\nThe ASGI specification defines a root_path for this use case.\n\nAnd the --root-path command line option provides that root_path.\n\nYou can get the current root_path used by your application for each request, it is part of the scope dictionary (that's part of the ASGI spec).\n\nHere we are including it in the message just for demonstration purposes.\n\nThen, if you start Uvicorn with:\n\nThe response would be something like:\n\nAlternatively, if you don't have a way to provide a command line option like --root-path or equivalent, you can set the root_path parameter when creating your FastAPI app:\n\nPassing the root_path to FastAPI would be the equivalent of passing the --root-path command line option to Uvicorn or Hypercorn.\n\nKeep in mind that the server (Uvicorn) won't use that root_path for anything else than passing it to the app.\n\nBut if you go with your browser to http://127.0.0.1:8000/app you will see the normal response:\n\nSo, it won't expect to be accessed at http://127.0.0.1:8000/api/v1/app.\n\nUvicorn will expect the proxy to access Uvicorn at http://127.0.0.1:8000/app, and then it would be the proxy's responsibility to add the extra /api/v1 prefix on top.\n\nKeep in mind that a proxy with stripped path prefix is only one of the ways to configure it.\n\nProbably in many cases the default will be that the proxy doesn't have a stripped path prefix.\n\nIn a case like that (without a stripped path prefix), the proxy would listen on something like https://myawesomeapp.com, and then if the browser goes to https://myawesomeapp.com/api/v1/app and your server (e.g. Uvicorn) listens on http://127.0.0.1:8000 the proxy (without a stripped path prefix) would access Uvicorn at the same path: http://127.0.0.1:8000/api/v1/app.\n\nYou can easily run the experiment locally with a stripped path prefix using Traefik.\n\nDownload Traefik, it's a single binary, you can extract the compressed file and run it directly from the terminal.\n\nThen create a file traefik.toml with:\n\nThis tells Traefik to listen on port 9999 and to use another file routes.toml.\n\nWe are using port 9999 instead of the standard HTTP port 80 so that you don't have to run it with admin (sudo) privileges.\n\nNow create that other file routes.toml:\n\nThis file configures Traefik to use the path prefix /api/v1.\n\nAnd then Traefik will redirect its requests to your Uvicorn running on http://127.0.0.1:8000.\n\nAnd now start your app, using the --root-path option:\n\nNow, if you go to the URL with the port for Uvicorn: http://127.0.0.1:8000/app, you will see the normal response:\n\nNotice that even though you are accessing it at http://127.0.0.1:8000/app it shows the root_path of /api/v1, taken from the option --root-path.\n\nAnd now open the URL with the port for Traefik, including the path prefix: http://127.0.0.1:9999/api/v1/app.\n\nWe get the same response:\n\nbut this time at the URL with the prefix path provided by the proxy: /api/v1.\n\nOf course, the idea here is that everyone would access the app through the proxy, so the version with the path prefix /api/v1 is the \"correct\" one.\n\nAnd the version without the path prefix (http://127.0.0.1:8000/app), provided by Uvicorn directly, would be exclusively for the proxy (Traefik) to access it.\n\nThat demonstrates how the Proxy (Traefik) uses the path prefix and how the server (Uvicorn) uses the root_path from the option --root-path.\n\nBut here's the fun part. ‚ú®\n\nThe \"official\" way to access the app would be through the proxy with the path prefix that we defined. So, as we would expect, if you try the docs UI served by Uvicorn directly, without the path prefix in the URL, it won't work, because it expects to be accessed through the proxy.\n\nYou can check it at http://127.0.0.1:8000/docs:\n\nBut if we access the docs UI at the \"official\" URL using the proxy with port 9999, at /api/v1/docs, it works correctly! üéâ\n\nYou can check it at http://127.0.0.1:9999/api/v1/docs:\n\nRight as we wanted it. ‚úîÔ∏è\n\nThis is because FastAPI uses this root_path to create the default server in OpenAPI with the URL provided by root_path.\n\nThis is a more advanced use case. Feel free to skip it.\n\nBy default, FastAPI will create a server in the OpenAPI schema with the URL for the root_path.\n\nBut you can also provide other alternative servers, for example if you want the same docs UI to interact with both a staging and a production environment.\n\nIf you pass a custom list of servers and there's a root_path (because your API lives behind a proxy), FastAPI will insert a \"server\" with this root_path at the beginning of the list.\n\nWill generate an OpenAPI schema like:\n\nNotice the auto-generated server with a url value of /api/v1, taken from the root_path.\n\nIn the docs UI at http://127.0.0.1:9999/api/v1/docs it would look like:\n\nThe docs UI will interact with the server that you select.\n\nIf you don't want FastAPI to include an automatic server using the root_path, you can use the parameter root_path_in_servers=False:\n\nand then it won't include it in the OpenAPI schema.\n\nIf you need to mount a sub-application (as described in Sub Applications - Mounts) while also using a proxy with root_path, you can do it normally, as you would expect.\n\nFastAPI will internally use the root_path smartly, so it will just work. ‚ú®",
  "headings": [
    {
      "level": "h1",
      "text": "Behind a Proxy¬∂",
      "id": "behind-a-proxy"
    },
    {
      "level": "h2",
      "text": "Proxy Forwarded Headers¬∂",
      "id": "proxy-forwarded-headers"
    },
    {
      "level": "h3",
      "text": "Enable Proxy Forwarded Headers¬∂",
      "id": "enable-proxy-forwarded-headers"
    },
    {
      "level": "h3",
      "text": "Redirects with HTTPS¬∂",
      "id": "redirects-with-https"
    },
    {
      "level": "h3",
      "text": "How Proxy Forwarded Headers Work¬∂",
      "id": "how-proxy-forwarded-headers-work"
    },
    {
      "level": "h2",
      "text": "Proxy with a stripped path prefix¬∂",
      "id": "proxy-with-a-stripped-path-prefix"
    },
    {
      "level": "h3",
      "text": "Providing the root_path¬∂",
      "id": "providing-the-root-path"
    },
    {
      "level": "h3",
      "text": "Checking the current root_path¬∂",
      "id": "checking-the-current-root-path"
    },
    {
      "level": "h3",
      "text": "Setting the root_path in the FastAPI app¬∂",
      "id": "setting-the-root-path-in-the-fastapi-app"
    },
    {
      "level": "h3",
      "text": "About root_path¬∂",
      "id": "about-root-path"
    },
    {
      "level": "h2",
      "text": "About proxies with a stripped path prefix¬∂",
      "id": "about-proxies-with-a-stripped-path-prefix"
    },
    {
      "level": "h2",
      "text": "Testing locally with Traefik¬∂",
      "id": "testing-locally-with-traefik"
    },
    {
      "level": "h3",
      "text": "Check the responses¬∂",
      "id": "check-the-responses"
    },
    {
      "level": "h3",
      "text": "Check the docs UI¬∂",
      "id": "check-the-docs-ui"
    },
    {
      "level": "h2",
      "text": "Additional servers¬∂",
      "id": "additional-servers"
    },
    {
      "level": "h3",
      "text": "Disable automatic server from root_path¬∂",
      "id": "disable-automatic-server-from-root-path"
    },
    {
      "level": "h2",
      "text": "Mounting a sub-application¬∂",
      "id": "mounting-a-sub-application"
    }
  ],
  "code_samples": [
    {
      "code": "$ fastapi run --forwarded-allow-ips=\"*\"\n\n<span style=\"color: green;\">INFO</span>:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)",
      "language": "unknown"
    },
    {
      "code": "from fastapi import FastAPI\n\napp = FastAPI()\n\n\n@app.get(\"/items/\")\ndef read_items():\n    return [\"plumbus\", \"portal gun\"]",
      "language": "python"
    },
    {
      "code": "https://mysuperapp.com/items/",
      "language": "unknown"
    },
    {
      "code": "sequenceDiagram\n    participant Client\n    participant Proxy as Proxy/Load Balancer\n    participant Server as FastAPI Server\n\n    Client->>Proxy: HTTPS Request<br/>Host: mysuperapp.com<br/>Path: /items\n\n    Note over Proxy: Proxy adds forwarded headers\n\n    Proxy->>Server: HTTP Request<br/>X-Forwarded-For: [client IP]<br/>X-Forwarded-Proto: https<br/>X-Forwarded-Host: mysuperapp.com<br/>Path: /items\n\n    Note over Server: Server interprets headers<br/>(if --forwarded-allow-ips is set)\n\n    Server->>Proxy: HTTP Response<br/>with correct HTTPS URLs\n\n    Proxy->>Client: HTTPS Response",
      "language": "unknown"
    },
    {
      "code": "from fastapi import FastAPI, Request\n\napp = FastAPI()\n\n\n@app.get(\"/app\")\ndef read_main(request: Request):\n    return {\"message\": \"Hello World\", \"root_path\": request.scope.get(\"root_path\")}",
      "language": "python"
    },
    {
      "code": "graph LR\n\nbrowser(\"Browser\")\nproxy[\"Proxy on http://0.0.0.0:9999/api/v1/app\"]\nserver[\"Server on http://127.0.0.1:8000/app\"]\n\nbrowser --> proxy\nproxy --> server",
      "language": "unknown"
    },
    {
      "code": "{\n    \"openapi\": \"3.1.0\",\n    // More stuff here\n    \"servers\": [\n        {\n            \"url\": \"/api/v1\"\n        }\n    ],\n    \"paths\": {\n            // More stuff here\n    }\n}",
      "language": "unknown"
    },
    {
      "code": "$ fastapi run main.py --forwarded-allow-ips=\"*\" --root-path /api/v1\n\n<span style=\"color: green;\">INFO</span>:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)",
      "language": "unknown"
    },
    {
      "code": "from fastapi import FastAPI, Request\n\napp = FastAPI()\n\n\n@app.get(\"/app\")\ndef read_main(request: Request):\n    return {\"message\": \"Hello World\", \"root_path\": request.scope.get(\"root_path\")}",
      "language": "python"
    },
    {
      "code": "$ fastapi run main.py --forwarded-allow-ips=\"*\" --root-path /api/v1\n\n<span style=\"color: green;\">INFO</span>:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)",
      "language": "unknown"
    },
    {
      "code": "{\n    \"message\": \"Hello World\",\n    \"root_path\": \"/api/v1\"\n}",
      "language": "unknown"
    },
    {
      "code": "from fastapi import FastAPI, Request\n\napp = FastAPI(root_path=\"/api/v1\")\n\n\n@app.get(\"/app\")\ndef read_main(request: Request):\n    return {\"message\": \"Hello World\", \"root_path\": request.scope.get(\"root_path\")}",
      "language": "python"
    },
    {
      "code": "{\n    \"message\": \"Hello World\",\n    \"root_path\": \"/api/v1\"\n}",
      "language": "unknown"
    },
    {
      "code": "[entryPoints]\n  [entryPoints.http]\n    address = \":9999\"\n\n[providers]\n  [providers.file]\n    filename = \"routes.toml\"",
      "language": "unknown"
    },
    {
      "code": "[http]\n  [http.middlewares]\n\n    [http.middlewares.api-stripprefix.stripPrefix]\n      prefixes = [\"/api/v1\"]\n\n  [http.routers]\n\n    [http.routers.app-http]\n      entryPoints = [\"http\"]\n      service = \"app\"\n      rule = \"PathPrefix(`/api/v1`)\"\n      middlewares = [\"api-stripprefix\"]\n\n  [http.services]\n\n    [http.services.app]\n      [http.services.app.loadBalancer]\n        [[http.services.app.loadBalancer.servers]]\n          url = \"http://127.0.0.1:8000\"",
      "language": "unknown"
    },
    {
      "code": "$ ./traefik --configFile=traefik.toml\n\nINFO[0000] Configuration loaded from file: /home/user/awesomeapi/traefik.toml",
      "language": "unknown"
    },
    {
      "code": "$ fastapi run main.py --forwarded-allow-ips=\"*\" --root-path /api/v1\n\n<span style=\"color: green;\">INFO</span>:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)",
      "language": "unknown"
    },
    {
      "code": "{\n    \"message\": \"Hello World\",\n    \"root_path\": \"/api/v1\"\n}",
      "language": "unknown"
    },
    {
      "code": "{\n    \"message\": \"Hello World\",\n    \"root_path\": \"/api/v1\"\n}",
      "language": "unknown"
    },
    {
      "code": "from fastapi import FastAPI, Request\n\napp = FastAPI(\n    servers=[\n        {\"url\": \"https://stag.example.com\", \"description\": \"Staging environment\"},\n        {\"url\": \"https://prod.example.com\", \"description\": \"Production environment\"},\n    ],\n    root_path=\"/api/v1\",\n)\n\n\n@app.get(\"/app\")\ndef read_main(request: Request):\n    return {\"message\": \"Hello World\", \"root_path\": request.scope.get(\"root_path\")}",
      "language": "python"
    },
    {
      "code": "{\n    \"openapi\": \"3.1.0\",\n    // More stuff here\n    \"servers\": [\n        {\n            \"url\": \"/api/v1\"\n        },\n        {\n            \"url\": \"https://stag.example.com\",\n            \"description\": \"Staging environment\"\n        },\n        {\n            \"url\": \"https://prod.example.com\",\n            \"description\": \"Production environment\"\n        }\n    ],\n    \"paths\": {\n            // More stuff here\n    }\n}",
      "language": "unknown"
    },
    {
      "code": "from fastapi import FastAPI, Request\n\napp = FastAPI(\n    servers=[\n        {\"url\": \"https://stag.example.com\", \"description\": \"Staging environment\"},\n        {\"url\": \"https://prod.example.com\", \"description\": \"Production environment\"},\n    ],\n    root_path=\"/api/v1\",\n    root_path_in_servers=False,\n)\n\n\n@app.get(\"/app\")\ndef read_main(request: Request):\n    return {\"message\": \"Hello World\", \"root_path\": request.scope.get(\"root_path\")}",
      "language": "python"
    }
  ],
  "patterns": [
    {
      "description": "The docs UI would also need the OpenAPI schema to declare that this API server is located at /api/v1 (behind the proxy). For example:",
      "code": "server"
    },
    {
      "description": "For example:",
      "code": "from fastapi import FastAPI, Request\n\napp = FastAPI(\n    servers=[\n        {\"url\": \"https://stag.example.com\", \"description\": \"Staging environment\"},\n        {\"url\": \"https://prod.example.com\", \"description\": \"Production environment\"},\n    ],\n    root_path=\"/api/v1\",\n)\n\n\n@app.get(\"/app\")\ndef read_main(request: Request):\n    return {\"message\": \"Hello World\", \"root_path\": request.scope.get(\"root_path\")}"
    }
  ],
  "links": [
    "https://fastapi.tiangolo.com/advanced/behind-a-proxy/",
    "https://fastapi.tiangolo.com/deployment/https/",
    "https://fastapi.tiangolo.com/advanced/sub-applications/"
  ]
}