# ?降??銵?Spike

## ?格?
- 瘥??暹? `network_analysis_results.json` ??PCAP 閫??瘚?嚗??閬死???????摨?雿?
- 摰儔 `protocolStates` ???急?嗅?臬?函?璅?鞈?蝯?嚗Ⅱ靽?Phase 1/2 閬???霅啁??賢?具?
- 閬??桀?皜祈岫閬?蝭???鞈湛?撱箇???皜祈岫撉冽嚗靘踹?蝥???`vitest` ??憿??嗚?

## ?暹??日?
- 靘?嚗network_analysis_results.json` ?桀??? `basic_stats`?packet_loss`?latency` ??`mind_map`嚗撩 `connections`嚗??典?蝡航?朣???
- `latency.inter_packet_delays` ??撠????唾???嚗?憒?`7.79ms`?9.61ms`?7.11ms`?7.13ms`?1.85ms` 蝑?雿?蝭憟蝷?
- `tmp_test_capture.pcap`/`????pcapng` ???Scapy ??pyshark 閫??嚗??扳???格?摰瘚?嚗?霅??摨西??孵??扼?

## 蝯曹?鞈? Schema 撱箄降
```ts
// 瘥????????撅斗?餈?
interface ProtocolTimeline {
  id: string              // ex: tcp-10.0.0.5-443-12345
  protocol: 'tcp' | 'udp' | 'icmp' | 'dns' | 'http' | 'https' | 'timeout'
  startEpochMs: number    // 靘 PCAP timestamp
  endEpochMs: number
  stages: ProtocolStage[]
  metrics?: ProtocolMetrics
  anomalyTags?: string[]
}

interface ProtocolStage {
  key: string             // ex: syn, syn-ack, ack
  label: string           // 憿舐內?冽?摮?
  direction: 'forward' | 'backward' | 'wait' | 'none'
  durationMs: number      // 撖阡???蝞?????
  packetRefs?: PacketRef[]
}

interface PacketRef {
  index: number           // 撠?摨?
  timestamp: number
  size: number
}

interface ProtocolMetrics {
  rttMs?: number
  packetCount?: number
  retries?: number
  statusCode?: number | string
}
```

### ?????撠?
| Schema 甈?           | 靘?甈? / 撌亙                                 | ?酉 |
|-----------------------|-----------------------------------------------|------|
| `id`                  | `src_ip`+`dst_ip`+`src_port`+`dst_port`       | ?敺垢鋆? connections ?” |
| `startEpochMs`/`endEpochMs` | PCAP 銝剔洵銝/?敺?????                     | ?亦撩嚗隞?`latency.inter_packet_delays` 蝝臬?隡啁? |
| `stages.durationMs`   | ?祕撠?????閮剖??怎?憟芋??                | Phase 1嚗?閮?fallback ?喲?閮剖?|
| `metrics.statusCode`  | HTTP 閫??蝯?嚗?蝡航???                     | Phase 2 撘 |
| `anomalyTags`         | 敺垢?啣虜?菜葫閬?蝯?                          | Phase 3 撠? |

## 撠???瘥?瘚?
1. 閫?? PCAP嚗誑 Scapy `rdpcap` ??pyshark ?賢? 3 頝舀??4 頝舀??HTTP request-response ?祕??timestamp??
2. 撱箇?撠?摨?嚗? `frame_number` ??嚗???`(time_delta * 1000)` 雿 `durationMs`??
3. ???思葉??閮剔?憟?頛?
   - 3-Way Handshake嚗?撖?SYN?YN-ACK?CK ?祕?蜇?瑕漲嚗 < 300ms ?舀?撠???1500ms嚗??冽?嗅?批???`durationMultiplier`??
   - 4-Way Handshake嚗Ⅱ隤?FIN/ACK/FIN/ACK ??嚗摮 TIME-WAIT嚗?憿?璅內撱嗡撓??畾萸?
   - Timeout嚗?????脫趙璅?嚗?4s嚗??⊥??銝剝??脫撓霈孛?潮???
4. ?Ｗ `protocol_timeline_sample.json`嚗?蝥?TODO嚗?雿?垢??? fixture??

## ??批?刻??箄?獢?
- `ProtocolAnimationController` ?亙? `ProtocolTimeline`嚗雁霅瘀?
  - `currentStageIndex`
  - `elapsedMs`
  - `playbackSpeed`嚗?.5???????嚗?
  - `loopMode`嚗nce / loop / ping-pong嚗?
- ?折?寞?嚗?
  - `advance(deltaMs)`嚗? `playbackSpeed` 憓? `elapsedMs`嚗??撠? stage??
  - `seek(targetMs)`嚗?潭??遘???
  - `getRenderableState()`嚗??喟???脯?蝵柴?隤?阡＊蝷粹?鈭桃???
- 鈭辣?文?嚗onStageEnter(stage)`, `onStageComplete(stage)`嚗?靘?UI 敶?/霅衣內?∟孛?潮???

## ?桀?皜祈岫蝑
- ??`vitest` + `@testing-library/react`嚗?蝥???`package.json` ?啣? script嚗?
- 閬??Ｗ?嚗?
  1. 霈??timeline ??摨???閮?甇?Ⅱ嚗???fallback嚗?
  2. `advance()` ?其???`playbackSpeed` 銝蝣箏祕?? stage??
  3. `seek()` ?航歲頧銝剝??挾銝衣雁?????氬?
  4. Timeout ??UDP ?∪???憓?`getRenderableState()` ?餈?蝑?????怠惇?扼?
  5. ?啣虜 tags ?脣?孛??`onStageEnter` 鈭辣??
- 靘陷嚗?皞? fixture 瑼?`fixtures/sample_tcp_handshake.json` 蝑?

## 敺捱霅?/ TODO
- 敺垢?臬?舀?靘?`connections` ??霅啣?畾菔????亦?瘜??臬?啣? `analysis_server.py` ??API 隞交?氬?
- PCAP 閫??撌亙?豢???甈?甈橘?Scapy v2.5? pyshark?嚗?
- `ProtocolAnimationController` ?曄蔭雿蔭嚗src/lib/animations/`嚗?隞亙???React component ??撘?
- 皜祈岫獢撠??嚗hase 0 ??隤踵 `package.json`嚗??敺?瑽?
- ?臬?閬?Web Worker ??憭扯???????蝞??踹?銝餃銵? jank??

### Fixture Pipeline Notes
- `scripts/export_protocol_timeline_sample.py` parses `tmp_test_capture.pcap` and `\u6389\u5c01\u5305.pcapng` to emit `docs/protocol_timeline_sample.json`.
- Output `ProtocolTimeline` entries now include real RTT-derived durations and packet indices for TCP handshakes and UDP flows.
- Regenerate fixtures whenever capture files change: `python scripts/export_protocol_timeline_sample.py`. FastAPI now exposes the latest fixture via `GET /api/timelines` for frontend consumption.
