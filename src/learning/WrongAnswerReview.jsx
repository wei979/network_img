/**
 * WrongAnswerReview.jsx - éŒ¯é¡Œå›é¡§çµ„ä»¶
 *
 * åŠŸèƒ½ï¼š
 * - é¡¯ç¤ºä½¿ç”¨è€…ç­”éŒ¯çš„é¡Œç›®åˆ—è¡¨
 * - æ”¯æ´é‡æ–°ä½œç­”é€²è¡Œè¤‡ç¿’
 * - è¿½è¹¤è¤‡ç¿’é€²åº¦èˆ‡æŒæ¡ç‹€æ…‹
 */

import React, { useState, useCallback, useMemo } from 'react'
import {
  X,
  BookOpen,
  CheckCircle2,
  XCircle,
  RefreshCw,
  Trash2,
  Filter,
  ChevronDown,
  ChevronUp,
  AlertCircle,
  Award,
  RotateCcw
} from 'lucide-react'
import { LearningStorage } from './LearningStorage'

/**
 * å–®ä¸€éŒ¯é¡Œå¡ç‰‡çµ„ä»¶
 */
function WrongAnswerCard({
  wrongAnswer,
  isExpanded,
  onToggle,
  onRetry,
  showAnswer = false
}) {
  const [selectedAnswer, setSelectedAnswer] = useState(null)
  const [hasAnswered, setHasAnswered] = useState(false)
  const isCorrect = selectedAnswer === wrongAnswer.correctAnswer

  const handleSelectAnswer = (index) => {
    if (hasAnswered) return
    setSelectedAnswer(index)
  }

  const handleSubmitAnswer = () => {
    if (selectedAnswer === null) return
    setHasAnswered(true)

    // å¦‚æœç­”å°äº†ï¼Œæ¨™è¨˜ç‚ºå·²æŒæ¡
    if (isCorrect) {
      LearningStorage.markWrongAnswerMastered(
        wrongAnswer.quizId,
        wrongAnswer.questionId
      )
    } else {
      // å¢åŠ è¤‡ç¿’æ¬¡æ•¸
      LearningStorage.incrementReviewCount(
        wrongAnswer.quizId,
        wrongAnswer.questionId
      )
    }

    onRetry?.()
  }

  const handleReset = () => {
    setSelectedAnswer(null)
    setHasAnswered(false)
  }

  // å–å¾—é—œå¡åç¨±
  const levelName = useMemo(() => {
    const levelMatch = wrongAnswer.quizId?.match(/level(\d+)/)
    if (levelMatch) {
      const levelNum = levelMatch[1]
      const levelNames = {
        '1': 'Level 1: å…¥é–€',
        '2': 'Level 2: æ ¸å¿ƒ',
        '3': 'Level 3: é€²éš',
        '4': 'Level 4: å°ˆæ¥­',
        '5': 'Level 5: å°ˆå®¶'
      }
      return levelNames[levelNum] || `Level ${levelNum}`
    }
    return wrongAnswer.quizId
  }, [wrongAnswer.quizId])

  return (
    <div className={`
      rounded-xl border transition-all duration-200
      ${wrongAnswer.masteredAt
        ? 'bg-emerald-500/10 border-emerald-500/30'
        : 'bg-slate-800/50 border-slate-700 hover:border-slate-600'
      }
    `}>
      {/* å¡ç‰‡é ­éƒ¨ */}
      <button
        onClick={onToggle}
        className="w-full p-4 flex items-start gap-3 text-left"
      >
        <div className={`
          flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center
          ${wrongAnswer.masteredAt
            ? 'bg-emerald-500/20'
            : 'bg-red-500/20'
          }
        `}>
          {wrongAnswer.masteredAt ? (
            <CheckCircle2 className="w-4 h-4 text-emerald-400" />
          ) : (
            <XCircle className="w-4 h-4 text-red-400" />
          )}
        </div>

        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 mb-1">
            <span className="text-xs text-slate-500">{levelName}</span>
            {wrongAnswer.reviewCount > 0 && (
              <span className="text-xs text-amber-400">
                å·²è¤‡ç¿’ {wrongAnswer.reviewCount} æ¬¡
              </span>
            )}
          </div>
          <p className="text-white font-medium line-clamp-2">
            {wrongAnswer.question}
          </p>
        </div>

        <div className="flex-shrink-0">
          {isExpanded ? (
            <ChevronUp className="w-5 h-5 text-slate-400" />
          ) : (
            <ChevronDown className="w-5 h-5 text-slate-400" />
          )}
        </div>
      </button>

      {/* å±•é–‹å…§å®¹ */}
      {isExpanded && (
        <div className="px-4 pb-4 space-y-4">
          {/* é¸é …åˆ—è¡¨ */}
          <div className="space-y-2 pl-11">
            {wrongAnswer.options?.map((option, index) => {
              const isSelected = selectedAnswer === index
              const isCorrectAnswer = wrongAnswer.correctAnswer === index
              const wasUserAnswer = wrongAnswer.userAnswer === index

              let optionStyle = 'border-slate-600 hover:border-cyan-500/50'

              if (hasAnswered || showAnswer) {
                if (isCorrectAnswer) {
                  optionStyle = 'border-emerald-500 bg-emerald-500/20'
                } else if (isSelected && !isCorrectAnswer) {
                  optionStyle = 'border-red-500 bg-red-500/20'
                } else if (wasUserAnswer && !showAnswer) {
                  optionStyle = 'border-amber-500/50 bg-amber-500/10'
                } else {
                  optionStyle = 'border-slate-700 opacity-50'
                }
              } else if (isSelected) {
                optionStyle = 'border-cyan-500 bg-cyan-500/20'
              }

              return (
                <button
                  key={index}
                  onClick={() => handleSelectAnswer(index)}
                  disabled={hasAnswered || showAnswer}
                  className={`
                    w-full p-3 rounded-lg border-2 transition-all duration-200
                    flex items-center gap-3 text-left text-sm
                    ${optionStyle}
                    ${(hasAnswered || showAnswer) ? 'cursor-default' : 'cursor-pointer'}
                  `}
                >
                  <div className={`
                    w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0
                    ${isSelected ? 'border-cyan-400' : 'border-slate-500'}
                    ${(hasAnswered || showAnswer) && isCorrectAnswer ? 'border-emerald-400 bg-emerald-400' : ''}
                    ${(hasAnswered || showAnswer) && isSelected && !isCorrectAnswer ? 'border-red-400 bg-red-400' : ''}
                  `}>
                    {(hasAnswered || showAnswer) && isCorrectAnswer && (
                      <CheckCircle2 className="w-3 h-3 text-white" />
                    )}
                    {hasAnswered && isSelected && !isCorrectAnswer && (
                      <XCircle className="w-3 h-3 text-white" />
                    )}
                    {!hasAnswered && !showAnswer && isSelected && (
                      <div className="w-2 h-2 rounded-full bg-cyan-400" />
                    )}
                  </div>

                  <span className={`
                    ${(hasAnswered || showAnswer) && isCorrectAnswer ? 'text-emerald-300 font-medium' : ''}
                    ${hasAnswered && isSelected && !isCorrectAnswer ? 'text-red-300' : ''}
                    ${!hasAnswered && !showAnswer ? 'text-slate-200' : ''}
                  `}>
                    {option}
                  </span>

                  {showAnswer && wasUserAnswer && !isCorrectAnswer && (
                    <span className="ml-auto text-xs text-amber-400">ä½ çš„ç­”æ¡ˆ</span>
                  )}
                </button>
              )
            })}
          </div>

          {/* è§£é‡‹ */}
          {(hasAnswered || showAnswer) && wrongAnswer.explanation && (
            <div className={`
              ml-11 p-3 rounded-lg border text-sm
              ${isCorrect
                ? 'bg-emerald-500/10 border-emerald-500/30'
                : 'bg-amber-500/10 border-amber-500/30'
              }
            `}>
              <div className="flex items-start gap-2">
                <BookOpen className={`w-4 h-4 mt-0.5 flex-shrink-0 ${
                  isCorrect ? 'text-emerald-400' : 'text-amber-400'
                }`} />
                <p className={isCorrect ? 'text-emerald-200' : 'text-amber-200'}>
                  {wrongAnswer.explanation}
                </p>
              </div>
            </div>
          )}

          {/* æ“ä½œæŒ‰éˆ• */}
          {!showAnswer && (
            <div className="flex items-center gap-2 pl-11">
              {!hasAnswered ? (
                <button
                  onClick={handleSubmitAnswer}
                  disabled={selectedAnswer === null}
                  className={`
                    px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 transition-all
                    ${selectedAnswer !== null
                      ? 'bg-cyan-600 hover:bg-cyan-500 text-white'
                      : 'bg-slate-700 text-slate-500 cursor-not-allowed'
                    }
                  `}
                >
                  <CheckCircle2 className="w-4 h-4" />
                  ç¢ºèªç­”æ¡ˆ
                </button>
              ) : (
                <>
                  {isCorrect ? (
                    <div className="flex items-center gap-2 text-emerald-400">
                      <Award className="w-4 h-4" />
                      <span className="text-sm font-medium">å·²æŒæ¡ï¼</span>
                    </div>
                  ) : (
                    <button
                      onClick={handleReset}
                      className="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-sm flex items-center gap-2"
                    >
                      <RotateCcw className="w-4 h-4" />
                      å†è©¦ä¸€æ¬¡
                    </button>
                  )}
                </>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  )
}

/**
 * WrongAnswerReview ä¸»çµ„ä»¶
 */
export default function WrongAnswerReview({
  isVisible = false,
  onClose
}) {
  const [wrongAnswers, setWrongAnswers] = useState([])
  const [stats, setStats] = useState(null)
  const [expandedId, setExpandedId] = useState(null)
  const [filter, setFilter] = useState('all') // 'all' | 'unmastered' | 'mastered'
  const [showAnswers, setShowAnswers] = useState(false)

  // è¼‰å…¥éŒ¯é¡Œæ•¸æ“š
  const loadData = useCallback(() => {
    const options = {}
    if (filter === 'unmastered') {
      options.unmasteredOnly = true
    }
    setWrongAnswers(LearningStorage.getWrongAnswers(options))
    setStats(LearningStorage.getWrongAnswerStats())
  }, [filter])

  // åˆå§‹åŒ–è¼‰å…¥
  React.useEffect(() => {
    if (isVisible) {
      loadData()
    }
  }, [isVisible, loadData])

  // ç¯©é¸å¾Œçš„éŒ¯é¡Œ
  const filteredWrongAnswers = useMemo(() => {
    if (filter === 'mastered') {
      return wrongAnswers.filter(wa => wa.masteredAt)
    }
    return wrongAnswers
  }, [wrongAnswers, filter])

  const handleToggleExpand = (id) => {
    setExpandedId(expandedId === id ? null : id)
  }

  const handleClearMastered = () => {
    if (window.confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²æŒæ¡çš„éŒ¯é¡Œå—ï¼Ÿ')) {
      LearningStorage.clearMasteredWrongAnswers()
      loadData()
    }
  }

  const handleClearAll = () => {
    if (window.confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰éŒ¯é¡Œè¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
      LearningStorage.clearAllWrongAnswers()
      loadData()
    }
  }

  if (!isVisible) return null

  return (
    <div className="fixed inset-0 z-[9998] flex items-center justify-center">
      {/* èƒŒæ™¯é®ç½© */}
      <div
        className="absolute inset-0 bg-black/80 backdrop-blur-sm"
        onClick={onClose}
      />

      {/* å½ˆçª—å…§å®¹ */}
      <div className="relative w-[90vw] max-w-2xl max-h-[85vh] bg-slate-900 rounded-2xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col">
        {/* æ¨™é¡Œåˆ— */}
        <div className="flex items-center justify-between px-6 py-4 border-b border-slate-700 bg-slate-800/50">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-red-500/20 rounded-lg">
              <AlertCircle className="w-5 h-5 text-red-400" />
            </div>
            <div>
              <h2 className="text-lg font-bold text-white">éŒ¯é¡Œæœ¬</h2>
              <p className="text-xs text-slate-400">
                è¤‡ç¿’ç­”éŒ¯çš„é¡Œç›®ï¼Œå¼·åŒ–è–„å¼±ç’°ç¯€
              </p>
            </div>
          </div>
          <button
            onClick={onClose}
            className="p-2 rounded-lg hover:bg-slate-700 transition-colors"
          >
            <X className="w-5 h-5 text-slate-400" />
          </button>
        </div>

        {/* çµ±è¨ˆè³‡è¨Š */}
        {stats && (
          <div className="px-6 py-4 bg-slate-800/30 border-b border-slate-700/50">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-6">
                <div className="text-center">
                  <div className="text-2xl font-bold text-white">{stats.total}</div>
                  <div className="text-xs text-slate-500">ç¸½éŒ¯é¡Œ</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl font-bold text-emerald-400">{stats.mastered}</div>
                  <div className="text-xs text-slate-500">å·²æŒæ¡</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl font-bold text-amber-400">{stats.unmastered}</div>
                  <div className="text-xs text-slate-500">å¾…è¤‡ç¿’</div>
                </div>
              </div>

              {/* æŒæ¡ç‡é€²åº¦æ¢ */}
              <div className="w-32">
                <div className="flex justify-between text-xs mb-1">
                  <span className="text-slate-500">æŒæ¡ç‡</span>
                  <span className="text-emerald-400">{stats.masteryRate}%</span>
                </div>
                <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-gradient-to-r from-emerald-500 to-cyan-500 transition-all duration-500"
                    style={{ width: `${stats.masteryRate}%` }}
                  />
                </div>
              </div>
            </div>
          </div>
        )}

        {/* å·¥å…·åˆ— */}
        <div className="flex items-center justify-between px-6 py-3 border-b border-slate-700/50">
          {/* ç¯©é¸ */}
          <div className="flex items-center gap-2">
            <Filter className="w-4 h-4 text-slate-500" />
            <select
              value={filter}
              onChange={(e) => setFilter(e.target.value)}
              className="bg-slate-700 border-none rounded-lg px-3 py-1.5 text-sm text-white focus:ring-2 focus:ring-cyan-500"
            >
              <option value="all">å…¨éƒ¨éŒ¯é¡Œ</option>
              <option value="unmastered">å¾…è¤‡ç¿’</option>
              <option value="mastered">å·²æŒæ¡</option>
            </select>
          </div>

          {/* æ“ä½œæŒ‰éˆ• */}
          <div className="flex items-center gap-2">
            <label className="flex items-center gap-2 text-sm text-slate-400 cursor-pointer">
              <input
                type="checkbox"
                checked={showAnswers}
                onChange={(e) => setShowAnswers(e.target.checked)}
                className="rounded bg-slate-700 border-slate-600 text-cyan-500 focus:ring-cyan-500"
              />
              é¡¯ç¤ºç­”æ¡ˆ
            </label>

            {stats?.mastered > 0 && (
              <button
                onClick={handleClearMastered}
                className="p-2 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-amber-400 transition-colors"
                title="æ¸…é™¤å·²æŒæ¡"
              >
                <RefreshCw className="w-4 h-4" />
              </button>
            )}

            {stats?.total > 0 && (
              <button
                onClick={handleClearAll}
                className="p-2 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-red-400 transition-colors"
                title="æ¸…é™¤å…¨éƒ¨"
              >
                <Trash2 className="w-4 h-4" />
              </button>
            )}
          </div>
        </div>

        {/* éŒ¯é¡Œåˆ—è¡¨ */}
        <div className="flex-1 overflow-auto p-4 space-y-3">
          {filteredWrongAnswers.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-16 text-center">
              <div className="w-16 h-16 rounded-full bg-emerald-500/20 flex items-center justify-center mb-4">
                <CheckCircle2 className="w-8 h-8 text-emerald-400" />
              </div>
              <h3 className="text-lg font-semibold text-white mb-2">
                {filter === 'unmastered' ? 'æ²’æœ‰å¾…è¤‡ç¿’çš„éŒ¯é¡Œ' : 'æ²’æœ‰éŒ¯é¡Œè¨˜éŒ„'}
              </h3>
              <p className="text-slate-400 text-sm">
                {filter === 'unmastered'
                  ? 'å¤ªæ£’äº†ï¼ä½ å·²ç¶“æŒæ¡äº†æ‰€æœ‰éŒ¯é¡Œ'
                  : 'å®Œæˆæ¸¬é©—å¾Œï¼Œç­”éŒ¯çš„é¡Œç›®æœƒè‡ªå‹•è¨˜éŒ„åœ¨é€™è£¡'
                }
              </p>
            </div>
          ) : (
            filteredWrongAnswers.map((wrongAnswer) => (
              <WrongAnswerCard
                key={`${wrongAnswer.quizId}-${wrongAnswer.questionId}`}
                wrongAnswer={wrongAnswer}
                isExpanded={expandedId === `${wrongAnswer.quizId}-${wrongAnswer.questionId}`}
                onToggle={() => handleToggleExpand(`${wrongAnswer.quizId}-${wrongAnswer.questionId}`)}
                onRetry={loadData}
                showAnswer={showAnswers}
              />
            ))
          )}
        </div>

        {/* åº•éƒ¨æç¤º */}
        {filteredWrongAnswers.length > 0 && !showAnswers && (
          <div className="px-6 py-3 bg-slate-800/50 border-t border-slate-700 text-center">
            <p className="text-xs text-slate-500">
              ğŸ’¡ é»æ“Šé¡Œç›®å±•é–‹å¾Œé‡æ–°ä½œç­”ï¼Œç­”å°å³æ¨™è¨˜ç‚ºã€Œå·²æŒæ¡ã€
            </p>
          </div>
        )}
      </div>
    </div>
  )
}
